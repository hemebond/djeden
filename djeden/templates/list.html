{% extends "base_module.html" %}

{% load i18n %}
{% load sekizai_tags %}

{% block title %}list.html{% endblock %}

{% block content %}
	<form action="" method="get">
		{{ filter.form.as_p }}
		<input type="submit" />
	</form>

	<ul class="nav nav-tabs">
		<li class="active"><a href="#list" data-toggle="tab">List</a></li>
		<li><a href="#map" data-toggle="tab">Map</a></li>
	</ul>

	<div class="tab-content">
		<div class="tab-pane active" id="list">
			{% include "_table.html" %}
			{% include "_datatables.html" %}
			{% addtoblock "js_ready" %}
				$('.datatable').dataTable(plugin_options.datatables);
			{% endaddtoblock %}
		</div>

		<div class="tab-pane" id="map">
			<div id="map_canvas" style="height: 480px"></div>
		</div>
	</div>

	{% addtoblock "js" %}<script src="http://maps.google.com/maps/api/js?sensor=true" type="text/javascript"></script>{% endaddtoblock %}
	{% addtoblock "js" %}<script src="{{ STATIC_URL }}libs/jquery-ui-map-3.0-rc/ui/jquery.ui.map.js" type="text/javascript"></script>{% endaddtoblock %}

	<script>var mapvar = {};</script>

	{% addtoblock "js_ready" %}
		var markers = {{ json|safe }}

		$('a[data-toggle="tab"]').on('shown', function (e) {
			var tab = $('a[href=#map]', e.target);

			if (tab) {
				$('#map_canvas').gmap().bind('init', function(ev, map) {
					mapvar = map;
					$.each(markers, function(i, m) {
						if (m.lat && m.lon) {
							var name = m.name;
							var lat = m.lat.toString();
							var lon = m.lon.toString();

							$('#map_canvas').gmap(
								'addMarker',
								{
									'position': lat + ',' + lon,
									'bounds': true
								}
							).click(function() {
								$('#map_canvas').gmap(
									'openInfoWindow',
									{'content': name},
									this
								);
							});
						}
					});

					if (map.getZoom() > 10) {
						map.setZoom(5);
					}
				});
			}
		})
	{% endaddtoblock %}
{% endblock %}